[pytest]
# Test discovery and organization
testpaths =
    tests/unit
    tests/integration
    tests/performance
    tests/smoke
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Parallel execution configuration
addopts =
    -v
    --strict-markers
    --strict-config
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-report=json:coverage.json
    --cov-fail-under=85
    --durations=20
    --durations-min=0.1
    --maxfail=10
    --junitxml=test-results.xml
    --cache-clear
    # Parallel execution - uncomment for parallel testing
    # -n auto
    # --dist=loadfile

# Test markers for organization and selective execution
markers =
    # Test categories
    unit: mark as unit test (fast, isolated)
    integration: mark as integration test (components working together)
    performance: mark as performance test
    smoke: mark as smoke test for CI pipeline
    e2e: mark as end-to-end test (full pipeline)
    
    # Performance markers
    fast: mark as fast test (<1 second)
    slow: mark as slow test (>1 second)
    very_slow: mark as very slow test (>5 seconds)
    
    # Resource requirements
    gpu: mark as requiring GPU hardware
    network: mark as requiring network access
    ray: mark as requiring Ray cluster
    ml: mark as requiring ML dependencies (PyTorch, etc.)
    
    # Test types
    regression: mark as regression test
    memory: mark as memory usage test
    security: mark as security test
    stress: mark as stress test
    
    # Module-specific markers
    core: mark as core infrastructure test
    data: mark as data pipeline test
    model: mark as model architecture test
    training: mark as training pipeline test
    risk: mark as risk management test
    portfolio: mark as portfolio management test
    cli: mark as CLI interface test

# Warning filters
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::FutureWarning
    ignore::UserWarning
    ignore::RuntimeWarning
    ignore::pytest.PytestUnknownMarkWarning

# Test discovery exclusions
norecursedirs =
    .git
    .pytest_cache
    __pycache__
    *.egg-info
    build
    dist
    .venv
    venv
    env
    ray_results
    optimization_results
    experiments
    htmlcov
    test_optimization_results

# Minimum pytest version
minversion = 7.0

# Required plugins
required_plugins =
    pytest-cov
    pytest-mock
    pytest-xdist
    pytest-asyncio
    pytest-timeout
    pytest-benchmark

# Test execution configuration
testpaths_ignore =
    .git
    .pytest_cache
    __pycache__

# Coverage configuration
[coverage:run]
branch = True
source = src
include =
    src/trading_rl_agent/*.py
    src/trading_rl_agent/*/*.py
    src/trading_rl_agent/*/*/*.py
omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */migrations/*
    */venv/*
    */.venv/*
    */build/*
    */dist/*
    */site-packages/*
    */node_modules/*
    */coverage/*
    */htmlcov/*
    */.pytest_cache/*
    */ray_results/*
    */optimization_results/*
    */experiments/*
    */runs/*
    */wandb/*
    */mlruns/*
    */logs/*
    */temp/*
    */tmp/*
    */cache/*
    */__init__.py

[coverage:report]
show_missing = True
include =
    src/trading_rl_agent/*.py
    src/trading_rl_agent/*/*.py
    src/trading_rl_agent/*/*/*.py
omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */migrations/*
    */venv/*
    */.venv/*
    */build/*
    */dist/*
    */site-packages/*
    */node_modules/*
    */coverage/*
    */htmlcov/*
    */.pytest_cache/*
    */ray_results/*
    */optimization_results/*
    */experiments/*
    */runs/*
    */wandb/*
    */mlruns/*
    */logs/*
    */temp/*
    */tmp/*
    */cache/*
    */__init__.py
precision = 2
sort = True
show_branches = True

# Performance testing configuration
[benchmark]
min_rounds = 10
max_time = 10.0
warmup = true
disable_gc = true
timer = time.perf_counter

# Parallel execution profiles
[tool:pytest.ini_options]
# Fast test profile (unit tests only)
addopts_fast =
    -v
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-fail-under=85
    --durations=10
    --maxfail=5
    -m "fast and not slow and not very_slow"

# Full test profile (all tests)
addopts_full =
    -v
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-report=json:coverage.json
    --cov-fail-under=85
    --durations=20
    --maxfail=10
    --junitxml=test-results.xml

# Parallel test profile
addopts_parallel =
    -v
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-report=json:coverage.json
    --cov-fail-under=85
    --durations=20
    --maxfail=10
    --junitxml=test-results.xml
    -n auto
    --dist=loadfile

# CI/CD profile
addopts_ci =
    -v
    --tb=short
    --cov=src
    --cov-report=term-missing
    --cov-report=xml:coverage.xml
    --cov-fail-under=85
    --durations=10
    --maxfail=5
    --junitxml=test-results.xml
    -m "not very_slow"